# ---------------------------------------------------------
# Build Arguments
# ---------------------------------------------------------
ARG CUDA_MAJOR=12
ARG CUDA_MINOR=6
ARG CUDA_PATCH=2
ARG UBUNTU_RELEASE=22

# ---------------------------------------------------------
# Base Image: NVIDIA CUDA Devel
# We use 'devel' because we need 'nvcc' to compile ZED ROS2 Wrapper
# ---------------------------------------------------------
# ARG BASE_IMAGE=nvidia/cuda:${CUDA_MAJOR}.${CUDA_MINOR}.${CUDA_PATCH}-devel-ubuntu${UBUNTU_RELEASE}.04
# FROM ${BASE_IMAGE}
FROM tuttelikz/opencv-cuda:4.10.0-cuda12.6.3-arch8.9-ubuntu22.04


# all arguments after pulling from base image are flushed, so we re-declare them
ARG ZED_SDK_MAJOR=5
ARG ZED_SDK_MINOR=1
ARG ZED_SDK_PATCH=1
ARG CUDA_MAJOR=12
ARG CUDA_MINOR=8
ARG UBUNTU_RELEASE=22
ARG TENSORRT_MAJOR=10
ARG TENSORRT_MINOR=9

# Set environment variables
ENV LANG=C.UTF-8 \
        LC_ALL=C.UTF-8 \
        DEBIAN_FRONTEND=noninteractive \
        ROS_DISTRO=humble \
        # Critical for ZED SDK to access hardware
        NVIDIA_DRIVER_CAPABILITIES=all \
        TZ=Europe/Paris

# ---------------------------------------------------------
# 1. Install System Dependencies & ROS 2 Setup
# ---------------------------------------------------------
RUN apt-get update && apt-get install -y --no-install-recommends \
        build-essential \
        cmake \
        git \
        git-lfs \
        curl \
        wget \
        gnupg2 \
        lsb-release \
        ca-certificates \
        sudo \
        # ZED SDK Dependencies
        zstd \
        libusb-1.0-0-dev \
        libhidapi-libusb0 \
        libqt5core5a \
        # FFMPEG Dependencies (Needed for ZED streaming)
        libavcodec-dev \
        libavdevice-dev \
        libavformat-dev \
        libavutil-dev \
        libswscale-dev \
        # Python
        python3-pip \
        python3-dev \
        python3-setuptools \
        python3-opencv \
        # Networking/Utils
        iputils-ping \
        nano \
        tmux \
        usbutils \
        v4l-utils \
        # GUI Support (RQT/Rviz)
        libgl1-mesa-glx \
        libgl1-mesa-dri \
        && rm -rf /var/lib/apt/lists/*

# Add ROS 2 Humble Repository
RUN curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key -o /usr/share/keyrings/ros-archive-keyring.gpg && \
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] http://packages.ros.org/ros2/ubuntu $(lsb_release -cs) main" | tee /etc/apt/sources.list.d/ros2.list > /dev/null

# Install ROS 2 Desktop (Includes Rviz, RQT, etc.)
RUN apt-get update && apt-get install -y --no-install-recommends \
        ros-${ROS_DISTRO}-desktop \
        ros-${ROS_DISTRO}-ros-base \
        # Bridge & Teleop
        ros-${ROS_DISTRO}-foxglove-bridge \
        ros-${ROS_DISTRO}-joy \
        ros-${ROS_DISTRO}-joy-teleop \
        ros-${ROS_DISTRO}-backward-ros \
        # Image & PointCloud Transport
        ros-${ROS_DISTRO}-image-transport \
        ros-${ROS_DISTRO}-image-transport-plugins \
        ros-${ROS_DISTRO}-compressed-image-transport \
        ros-${ROS_DISTRO}-point-cloud-transport \
        ros-${ROS_DISTRO}-point-cloud-transport-plugins \
        # Navigation & Localization
        ros-${ROS_DISTRO}-robot-localization \
        ros-${ROS_DISTRO}-nmea-msgs \
        ros-${ROS_DISTRO}-mavros \
        ros-${ROS_DISTRO}-mavros-msgs \
        ros-${ROS_DISTRO}-marine-sensor-msgs \
        ros-${ROS_DISTRO}-marine-acoustic-msgs \
        # Visualization Tools
        ros-${ROS_DISTRO}-rqt-image-view \
        ros-${ROS_DISTRO}-rqt-graph \
        # Robot Description & Drivers
        ros-${ROS_DISTRO}-xacro \
        ros-${ROS_DISTRO}-robot-state-publisher \
        ros-${ROS_DISTRO}-diagnostic-updater \
        ros-${ROS_DISTRO}-usb-cam \
        ros-${ROS_DISTRO}-zed-msgs \
        # Build Tools
        python3-colcon-common-extensions \
        python3-rosdep \
        python3-vcstools \
        && rm -rf /var/lib/apt/lists/*

# Initialize rosdep
RUN rosdep init || true && rosdep update

# ---------------------------------------------------------
# 2. Install ZED SDK (Parameterized)
# ---------------------------------------------------------
ARG ZED_SDK_URL="https://stereolabs.sfo2.cdn.digitaloceanspaces.com/zedsdk/${ZED_SDK_MAJOR}.${ZED_SDK_MINOR}/ZED_SDK_Ubuntu${UBUNTU_RELEASE}_cuda${CUDA_MAJOR}.${CUDA_MINOR}_tensorrt${TENSORRT_MAJOR}.${TENSORRT_MINOR}_v${ZED_SDK_MAJOR}.${ZED_SDK_MINOR}.${ZED_SDK_PATCH}.zstd.run"
ARG ZED_SDK_RUN="ZED_SDK_installer.run"

RUN cd /tmp && \
        echo "Downloading ZED SDK from: ${ZED_SDK_URL}" && \
        wget --verbose --tries=5 --timeout=60 --no-check-certificate -O ${ZED_SDK_RUN} ${ZED_SDK_URL} && \
        echo "Download complete. File size: $(du -h ${ZED_SDK_RUN} | cut -f1)" && \
        chmod +x ${ZED_SDK_RUN}
# silent: No user interaction
# skip_cuda: Don't try to install CUDA Toolkit (Base image already has it)
# skip_python: Don't install pyzed (Wrapper uses C++, prevents pip conflicts)
RUN cd /tmp && ./${ZED_SDK_RUN} silent skip_cuda skip_python && \
        # since the installer installs to /usr/local/zed we need to set permissions for lib access
        # a for all user r for read and X for conditional execute (only allow executing if it is an actual executable)
        chmod -R a+rX /usr/local/zed && \
        # Update library cache
        ldconfig && \
        rm ${ZED_SDK_RUN} && \
        rm -rf /var/lib/apt/lists/*

# ---------------------------------------------------------
# 3. Install Python ML Libraries (Ultralytics/YOLO)
# ---------------------------------------------------------
# 1. Upgrade pip/setuptools
RUN pip3 install --no-cache-dir --upgrade pip setuptools wheel

# Base image already has opencv-python with CUDA support but pip doesn't recognize it since it 
# wasn't installed via pip, so we fake-install empty packages to satisfy dependencies

# Fake opencv-python
RUN mkdir -p /tmp/fake_cv && \
        echo 'from setuptools import setup; setup(name="opencv-python", version="4.10.0", packages=[])' > /tmp/fake_cv/setup.py && \
        pip3 install --no-cache-dir /tmp/fake_cv && \
        rm -rf /tmp/fake_cv

# Fake opencv-contrib-python
RUN mkdir -p /tmp/fake_cv_contrib && \
        echo 'from setuptools import setup; setup(name="opencv-contrib-python", version="4.10.0", packages=[])' > /tmp/fake_cv_contrib/setup.py && \
        pip3 install --no-cache-dir /tmp/fake_cv_contrib && \
        rm -rf /tmp/fake_cv_contrib

# Fake opencv-python-headless
RUN mkdir -p /tmp/fake_cv_headless && \
        echo 'from setuptools import setup; setup(name="opencv-python-headless", version="4.10.0", packages=[])' > /tmp/fake_cv_headless/setup.py && \
        pip3 install --no-cache-dir /tmp/fake_cv_headless && \
        rm -rf /tmp/fake_cv_headless

# Install actual requirements
# Ensure Docker/dev/constraints.txt DOES NOT contain opencv lines
COPY Docker/dev/requirements.txt Docker/dev/constraints.txt /tmp/
RUN pip3 install --no-cache-dir --ignore-installed  -c /tmp/constraints.txt -r /tmp/requirements.txt

# DOWNGRADE Setuptools for ROS 2
# ROS 2 Humble's colcon build system breaks with Setuptools >= 70.
RUN pip3 install --no-cache-dir "setuptools==65.5.1"

ARG USERNAME=douglas
ARG USER_UID=1000
ARG USER_GID=$USER_UID

# 1. Create or rename the group
RUN if getent group $USER_GID; then \
        groupmod -n $USERNAME $(getent group $USER_GID | cut -d: -f1); \
        else \
        groupadd --gid $USER_GID $USERNAME; \
        fi \
        # 2. Create the user
        && useradd --uid $USER_UID --gid $USER_GID -m -s /bin/bash $USERNAME \
        && echo $USERNAME ALL=\(root\) NOPASSWD:ALL > /etc/sudoers.d/$USERNAME \
        && chmod 0440 /etc/sudoers.d/$USERNAME \
        && usermod -aG video,render -s /bin/bash $USERNAME

# Install fixuid for dynamic UID/GID remapping at runtime
ARG FIXUID_VERSION=0.6.0
RUN ARCH="$(dpkg --print-architecture)" && \
        curl -fsSL "https://github.com/boxboat/fixuid/releases/download/v${FIXUID_VERSION}/fixuid-${FIXUID_VERSION}-linux-${ARCH}.tar.gz" | tar -C /usr/local/bin -xzf - && \
        chown root:root /usr/local/bin/fixuid && \
        chmod 4755 /usr/local/bin/fixuid && \
        mkdir -p /etc/fixuid && \
        printf "user: $USERNAME\ngroup: $USERNAME\n" > /etc/fixuid/config.yml

USER $USERNAME
WORKDIR /home/$USERNAME/AUV-2026
# Add source commands to bashrc
RUN echo "source /opt/ros/${ROS_DISTRO}/setup.bash" >> ~/.bashrc && \
        echo 'if [ -f "$HOME/AUV-2026/ros2_ws/install/setup.bash" ]; then source "$HOME/AUV-2026/ros2_ws/install/setup.bash"; fi' >> ~/.bashrc

# Entrypoint uses fixuid to remap UID/GID if running with --user
ENTRYPOINT ["fixuid", "-q"]

# Keep container alive
CMD ["bash"]
