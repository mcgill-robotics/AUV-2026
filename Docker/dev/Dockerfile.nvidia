# ---------------------------------------------------------
# Base Image: NVIDIA CUDA 12.8 Devel (Ubuntu 22.04)
# We use 'devel' because we need 'nvcc' to compile ZED ROS2 Wrapper
# ---------------------------------------------------------
ARG BASE_IMAGE=nvidia/cuda:12.8.0-devel-ubuntu22.04
FROM ${BASE_IMAGE}

# Set environment variables
ENV LANG=C.UTF-8 \
        LC_ALL=C.UTF-8 \
        DEBIAN_FRONTEND=noninteractive \
        ROS_DISTRO=humble \
        # Critical for ZED SDK to access hardware
        NVIDIA_DRIVER_CAPABILITIES=all \
        TZ=Europe/Paris

# ---------------------------------------------------------
# 1. Install System Dependencies & ROS 2 Setup
# ---------------------------------------------------------
RUN apt-get update && apt-get install -y --no-install-recommends \
        build-essential \
        cmake \
        git \
        git-lfs \
        curl \
        wget \
        gnupg2 \
        lsb-release \
        ca-certificates \
        sudo \
        # ZED SDK Dependencies
        zstd \
        libusb-1.0-0-dev \
        libhidapi-libusb0 \
        libqt5core5a \
        # FFMPEG Dependencies (Needed for ZED streaming)
        libavcodec-dev \
        libavdevice-dev \
        libavformat-dev \
        libavutil-dev \
        libswscale-dev \
        # Python
        python3-pip \
        python3-dev \
        python3-setuptools \
        python3-opencv \
        # Networking/Utils
        iputils-ping \
        nano \
        tmux \
        usbutils \
        v4l-utils \
        # GUI Support (RQT/Rviz)
        libgl1-mesa-glx \
        libgl1-mesa-dri \
        && rm -rf /var/lib/apt/lists/*

# Add ROS 2 Humble Repository
RUN curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key -o /usr/share/keyrings/ros-archive-keyring.gpg && \
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] http://packages.ros.org/ros2/ubuntu $(lsb_release -cs) main" | tee /etc/apt/sources.list.d/ros2.list > /dev/null

# Install ROS 2 Desktop (Includes Rviz, RQT, etc.)
RUN apt-get update && apt-get install -y --no-install-recommends \
        ros-${ROS_DISTRO}-desktop \
        ros-${ROS_DISTRO}-ros-base \
        # Bridge & Teleop
        ros-${ROS_DISTRO}-foxglove-bridge \
        ros-${ROS_DISTRO}-joy \
        ros-${ROS_DISTRO}-joy-teleop \
        # Image & PointCloud Transport
        ros-${ROS_DISTRO}-image-transport \
        ros-${ROS_DISTRO}-image-transport-plugins \
        ros-${ROS_DISTRO}-compressed-image-transport \
        ros-${ROS_DISTRO}-point-cloud-transport \
        ros-${ROS_DISTRO}-point-cloud-transport-plugins \
        # Navigation & Localization
        ros-${ROS_DISTRO}-robot-localization \
        ros-${ROS_DISTRO}-nmea-msgs \
        ros-${ROS_DISTRO}-mavros \
        ros-${ROS_DISTRO}-mavros-msgs \
        ros-${ROS_DISTRO}-marine-sensor-msgs \
        ros-${ROS_DISTRO}-marine-acoustic-msgs \
        # Visualization Tools
        ros-${ROS_DISTRO}-rqt-image-view \
        ros-${ROS_DISTRO}-rqt-graph \
        # Robot Description & Drivers
        ros-${ROS_DISTRO}-xacro \
        ros-${ROS_DISTRO}-robot-state-publisher \
        ros-${ROS_DISTRO}-diagnostic-updater \
        ros-${ROS_DISTRO}-usb-cam \
        ros-${ROS_DISTRO}-zed-msgs \
        # Build Tools
        python3-colcon-common-extensions \
        python3-rosdep \
        python3-vcstools \
        ros-${ROS_DISTRO}-backwards-ros \
        && rm -rf /var/lib/apt/lists/*

# Initialize rosdep
RUN rosdep init || true && rosdep update
# Install backward-ros so colcon build succeeds
RUN apt update && apt install -y ros-humble-backward-ros

# ---------------------------------------------------------
# 2. Install ZED SDK 5.1.1 (CUDA 12.8 / Ubuntu 22.04)
# ---------------------------------------------------------
ARG ZED_SDK_URL="https://stereolabs.sfo2.cdn.digitaloceanspaces.com/zedsdk/5.1/ZED_SDK_Ubuntu22_cuda12.8_tensorrt10.9_v5.1.1.zstd.run"
ARG ZED_SDK_RUN="ZED_SDK_Ubuntu22_cuda12.8_tensorrt10.9_v5.1.1.zstd.run"

RUN cd /tmp && \
        wget -q --no-check-certificate -O ${ZED_SDK_RUN} ${ZED_SDK_URL} && \
        chmod +x ${ZED_SDK_RUN} && \
        # silent: No user interaction
        # skip_cuda: Don't try to install CUDA Toolkit (Base image already has it)
        # skip_python: Don't install pyzed (Wrapper uses C++, prevents pip conflicts)
        ./${ZED_SDK_RUN} silent skip_cuda skip_python && \
        rm ${ZED_SDK_RUN} && \
        rm -rf /var/lib/apt/lists/*

# ---------------------------------------------------------
# 3. Install Python ML Libraries (Ultralytics/YOLO)
# ---------------------------------------------------------
# This will download the large PyTorch CUDA wheels automatically
RUN pip3 install --no-cache-dir \
        ultralytics \
        pandas \
        scipy \
        notebook \
        roboflow \
        albumentations \
        typing_extensions \
        sympy \
        cython


# ---------------------------------------------------------
# 4. Environment Setup
# ---------------------------------------------------------
# Add source commands to bashrc
RUN echo "source /opt/ros/${ROS_DISTRO}/setup.bash" >> /root/.bashrc && \
        echo "if [ -f /root/AUV-2026/ros2_ws/install/setup.bash ]; then source /root/AUV-2026/ros2_ws/install/setup.bash; fi" >> /root/.bashrc

# Default directory
WORKDIR /root/AUV-2026

# Keep container alive
CMD ["bash"]
