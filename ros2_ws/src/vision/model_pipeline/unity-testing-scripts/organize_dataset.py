#!/usr/bin/env python3
"""
Dataset Organization Script for YOLO Training

This script:
1. Scans data/raw_import for images and labels
2. Splits them into train/val/test sets (70/20/10)
3. Moves them to data/processed/{train,val,test}/{images,labels}
4. Generates data.yaml

Usage:
    python3 organize_dataset.py
"""

import os
import shutil
import random
from pathlib import Path

# Configuration
SCRIPT_DIR = Path(__file__).parent.resolve()
BASE_DIR = SCRIPT_DIR.parent # model_pipeline directory
RAW_IMPORT_DIR = BASE_DIR / "data" / "raw_import"
PROCESSED_DIR = BASE_DIR / "data" / "processed"
DATA_YAML_PATH = SCRIPT_DIR / "data.yaml"

# Split ratios
TRAIN_RATIO = 0.70
VAL_RATIO = 0.20
TEST_RATIO = 0.10

# Class names (must match label IDs in your .txt files)
CLASS_NAMES = [
    "gate",
    "lane_marker",
    "red_pipe",
    "white_pipe",
    "octagon",
    "table",
    "bin",
    "board",
    "shark",
    "sawfish"
]

IMAGE_EXTENSIONS = {".jpg", ".jpeg", ".png", ".bmp"}


def find_image_label_pairs(raw_dir: Path) -> list[tuple[Path, Path]]:
    """Find all image-label pairs in the raw import directory.
    
    Supports two structures:
    1. Separate folders: raw_import/images/*.jpg + raw_import/labels/*.txt
    2. Flat folder: raw_import/*.jpg + raw_import/*.txt (matching names)
    """
    pairs = []
    
    # Check for separate images/labels folders structure
    images_dir = raw_dir / "images"
    labels_dir = raw_dir / "labels"
    
    if images_dir.exists() and labels_dir.exists():
        # Separate folders structure
        print(f"Detected structure: {images_dir.name}/ + {labels_dir.name}/")
        for img_path in images_dir.iterdir():
            if img_path.suffix.lower() not in IMAGE_EXTENSIONS:
                continue
            
            # Look for matching label file
            label_path = labels_dir / (img_path.stem + ".txt")
            if label_path.exists():
                pairs.append((img_path, label_path))
            else:
                print(f"Warning: No label found for {img_path.name}")
    else:
        # Flat folder structure (images and labels in same directory)
        print("Detected structure: flat folder (images + labels together)")
        for img_path in raw_dir.iterdir():
            if img_path.suffix.lower() not in IMAGE_EXTENSIONS:
                continue
            
            label_path = img_path.with_suffix(".txt")
            if label_path.exists():
                pairs.append((img_path, label_path))
            else:
                print(f"Warning: No label found for {img_path.name}")
    
    return pairs


def create_directory_structure(processed_dir: Path):
    """Create the train/val/test directory structure."""
    # Clean slate: remove any existing processed data
    if processed_dir.exists():
        shutil.rmtree(processed_dir)
        print(f"Cleared existing {processed_dir}")
    
    for split in ["train", "val", "test"]:
        (processed_dir / split / "images").mkdir(parents=True, exist_ok=True)
        (processed_dir / split / "labels").mkdir(parents=True, exist_ok=True)


def split_and_move_data(pairs: list[tuple[Path, Path]], processed_dir: Path):
    """Shuffle and split data into train/val/test sets."""
    random.shuffle(pairs)
    
    n = len(pairs)
    train_end = int(n * TRAIN_RATIO)
    val_end = train_end + int(n * VAL_RATIO)
    
    splits = {
        "train": pairs[:train_end],
        "val": pairs[train_end:val_end],
        "test": pairs[val_end:]
    }
    
    for split_name, split_pairs in splits.items():
        img_dest = processed_dir / split_name / "images"
        lbl_dest = processed_dir / split_name / "labels"
        
        for img_path, lbl_path in split_pairs:
            shutil.copy2(img_path, img_dest / img_path.name)
            shutil.copy2(lbl_path, lbl_dest / lbl_path.name)
        
        print(f"{split_name}: {len(split_pairs)} images")
    
    return splits


def generate_data_yaml(processed_dir: Path, yaml_path: Path):
    """Generate the data.yaml file for YOLO training."""
    content = f"""# Auto-generated by organize_dataset.py
path: {processed_dir}
train: train/images
val: val/images
test: test/images

nc: {len(CLASS_NAMES)}
names: {CLASS_NAMES}
"""
    yaml_path.write_text(content)
    print(f"\nGenerated {yaml_path}")


def main():
    print("=" * 50)
    print("YOLO Dataset Organizer")
    print("=" * 50)
    
    # Check raw import directory
    if not RAW_IMPORT_DIR.exists():
        print(f"\nError: {RAW_IMPORT_DIR} does not exist.")
        print("Please create it and add your images + labels.")
        return
    
    # Find pairs
    print(f"\nScanning {RAW_IMPORT_DIR}...")
    pairs = find_image_label_pairs(RAW_IMPORT_DIR)
    
    if not pairs:
        print("No image-label pairs found!")
        print("Make sure your images (.jpg/.png) and labels (.txt) have matching names.")
        return
    
    print(f"Found {len(pairs)} image-label pairs.")
    
    # Create structure
    print(f"\nCreating directory structure in {PROCESSED_DIR}...")
    create_directory_structure(PROCESSED_DIR)
    
    # Split and move
    print("\nSplitting and copying files...")
    split_and_move_data(pairs, PROCESSED_DIR)
    
    # Generate YAML
    generate_data_yaml(PROCESSED_DIR, DATA_YAML_PATH)
    
    print("\n" + "=" * 50)
    print("Done! Your dataset is ready for training.")
    print(f"Next step: python3 training.py --model v8")
    print("=" * 50)


if __name__ == "__main__":
    main()
